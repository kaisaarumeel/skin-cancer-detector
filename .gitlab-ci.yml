default:
  tags:
    - docker

stages:
  - backend-code-quality
  - backend-api-tests

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  DOCKER_IMAGE: python:3.12

cache:
  # Cache by branch name
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
  # Cache pip downloads
    - .pip-cache/


.setup:
  image: $DOCKER_IMAGE
  before_script:
    # Install system dependencies for OpenCV
    - apt-get update
    - apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev
    # Install Python dependencies
    - python -m pip install -r requirements-ci.txt

backend-code-quality:
  extends: .setup
  stage: backend-code-quality
  script:
    # Ensure code is formatted correctly
    - python -m black . --check || (echo "❌ Code formatting check failed. Run 'black .' locally to fix formatting" && exit 1)
    
    # Ensure django system checks pass
    - cd server
    - python manage.py check || (echo "❌ Django system checks failed" && exit 1)
  rules: 
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/

backend-api-tests:
  extends: .setup
  stage: backend-api-tests
  script:
    - cd server
    - python manage.py test --verbosity=2
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/