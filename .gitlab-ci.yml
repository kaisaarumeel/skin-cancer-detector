default:
  tags:
    - docker

stages:
  - code-quality
  - api-tests

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  DOCKER_IMAGE: python:3.12

cache:
  # Cache by branch name and python image version
  key: "${CI_COMMIT_REF_SLUG}-py3.12"
  paths:
    - .pip-cache/
    - ~/.cache/pip
  policy: pull-push

.setup:
  image: $DOCKER_IMAGE
  before_script:
    # Install system dependencies for OpenCV
    - apt-get update
    - apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev

backend-code-quality:
  extends: .setup
  stage: code-quality
  script:
    # Upgrade pip
    - python -m pip install --upgrade pip
    # Install deps
    - python -m pip install -r requirements-ci.txt
    
    # Ensure code is formatted correctly
    - python -m black . --check || (echo "❌ Code formatting check failed. Run 'black .' locally to fix formatting" && exit 1)
    
    # Ensure django system checks pass
    - cd server
    - python manage.py check || (echo "❌ Django system checks failed" && exit 1)
  rules: 
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/

backend-api-tests:
  extends: .setup
  stage: api-tests
  script:
    # Install deps
    - python -m pip install -r requirements-ci.txt
    
    # Run backend tests
    - cd server
    - python manage.py test --verbosity=2
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/