default:
  tags:
    - docker  # Use the Docker runner

image: python:3.12  # Use official Python 3.12 image

stages:
  - backend-code-quality
  - backend-api-tests

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .pip-cache/

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

backend-code-quality:
  stage: backend-code-quality
  script:
    # Upgrade pip
    - python -m pip install --upgrade pip
    # Install deps
    - python -m pip install -r requirements-ci.txt
    
    # Ensure code is formatted correctly
    - python -m black . --check || (echo "❌ Code formatting check failed. Run 'black .' locally to fix formatting" && exit 1)
    
    # Ensure django system checks pass
    - cd server
    - python manage.py check || (echo "❌ Django system checks failed" && exit 1)
  rules: 
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/

backend-api-tests:
  stage: backend-api-tests
  script:
    - python -m pip cache purge
    # Upgrade pip
    - python -m pip install --upgrade pip
    # Install deps
    - python -m pip install -r requirements-ci.txt
    
    # Run backend tests
    - cd server
    - python manage.py test --verbosity=2
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /(main|develop)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(main|develop)/